name: LEMP Server
on:
  push:
    branches:
   # - src
    - main
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GIT_ENV: $(echo "${GITHUB_SHA}" | cut -c1-7)
    steps:
      - uses: actions/checkout@v3
      - name: apt update command
        run: sudo apt update
      - name: docker compose install
        run: sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      - name: docker execute
        run: sudo chmod +x /usr/local/bin/docker-compose
      - name: version check
        run: docker-compose --version
        
      - name: Build the Docker Images
        
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "PHP_TAG=${SHORT_SHA}" >> .env
          echo "NGINX_TAG=${SHORT_SHA}" >> .env
          echo "MYSQL_TAG=${SHORT_SHA}" >> .env
          echo "PHPMYADMIN_TAG=${SHORT_SHA}" >> .env
          echo "PHP_TAG=${SHORT_SHA}" >> $GITHUB_ENV
          cat .env
          echo "$GIT_ENV"
         
      - name: Build the Docker images
        run: docker-compose build
        
      - name: Logging into the Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        
      - name: Push the Docker Images to the Docker Hub
        run: | 
          cat .env
          docker images
          docker tag kashan1234/phpservicerepo:${SHORT_SHA} kashan1234/phpservicerepo:latest
          docker tag kashan1234/nginxrepo:${SHORT_SHA} kashan1234/nginxrepo:latest
          docker tag kashan1234/mysqlserviceimg:${SHORT_SHA} kashan1234/mysqlserviceimg:latest
          docker tag kashan1234/phpmyadminrepo:${SHORT_SHA} kashan1234/phpmyadminrepo:latest
          docker images
          docker-compose push
